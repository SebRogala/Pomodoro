name: Deploy to CapRover

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create deployment tarball
        run: tar -cvf deploy.tar --exclude='.git' --exclude='node_modules' --exclude='dist' .

      - name: Deploy to CapRover
        run: |
          curl -X POST \
            "${{ secrets.CAPROVER_SERVER }}/api/v2/user/apps/appData/${{ secrets.CAPROVER_APP }}" \
            -H "x-captain-app-token: ${{ secrets.CAPROVER_TOKEN }}" \
            -H "Content-Type: multipart/form-data" \
            -F "sourceFile=@deploy.tar" \
            --fail
